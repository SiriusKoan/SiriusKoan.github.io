<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 23 實作 user_bp (1)</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#user_helper">user_helper</a>
        <a href="#/login">/login</a>
        <a href="#/logout">/logout</a>
        <a href="#References">References</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 23 實作 user_bp (1)</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                今天要進入 <code>user_bp</code>，但因為他路徑太多太複雜，所以我們必須分段處理，而今天要處理的是驗證的部分。
            </p>
        </div>
        <div class="post_content" id="user_helper">
            <h2><a href="#user_helper">user_helper</a></h2>
            <p>
                在開始寫路徑之前，我們要先稍微處理一下 <code>login_manager</code>，接下來這個檔案要放在 <code>app/</code> 裡面。
            </p>
            <script src="https://gist.github.com/SiriusKoan/3823a6f9791f9926c8d34e21a441248b.js"></script>
            <p>
                在這裡面我們看到一個新的 <code>login_manager</code>，我們要用這個來做事，所以在 <code>__init__.py</code> 的那個就可以刪掉了，直接 <code>from .user_helper import login_manager</code>。
            </p>
            <p>
                在這邊我們做了很多事情，有點複雜，所以我不會完整解釋。我們先從最前面定義 <code>User</code> 開始。他繼承自從 Flask-Login 來的 <code>UserMixin</code>，功用是當一個 Flask-Login 需要的 user，他會在下面的 <code>load</code> 被用到。
            </p>
            <p>
                接著就看到下面的 <code>load</code>，他加上了一個 <code>login_manager.user_loader</code> 的裝飾器。在這個函式裡面，我們去資料庫找到這個使用者，然後把它包裝一下變成剛剛定義的 <code>User</code> 的形式，這樣 Flask-Login 才看得懂，而如果這個使用者不存在的話，那就回傳 <code>None</code>，這是官方文件指示的。這個函式基本上是在我們登入後，可能會想要找這個 user 是誰，那就需要這個 callback function 了，他是一個很核心的函式，沒有他基本上就動不了。
            </p>
            <p>
                這個檔案不會這麼快就結束，之後我們還會修改他，可以敬請期待。
            </p>
        </div>
        <div class="post_content" id="/login">
            <h2><a href="#/login">/login</a></h2>
            <p>
                在開始寫路徑之前，我們要先加入一些函式。
            </p>
            <script src="https://gist.github.com/SiriusKoan/c91328ae9910ca167cddb3cf6d5c6733.js"></script>
            <p>
                他要放在 <code>app/database/helper.py</code> 裡面，是用來驗證登入有沒有成功的工具。
            </p>
            <p>
                在這邊就要說一下 Flask-SQLAlchemy 要怎麼抓資料。我們先看 <code>Users.query</code>，前面的部分是這個 table 的 model，後面則是一個 query 物件，他也可以寫成 <code>db.session.query(Users)</code>，但我喜歡前者的寫法。接下來他有一個 <code>filter_by</code>，他就是一個過濾器，<code>username=username</code> 代表他要過濾出 <code>username</code> 欄位的值等於我想要的 <code>username</code> 的整個物件。例如說我現在要使用者名稱是 <code>siriuskoan</code> 的人，那就寫成 <code>filter_by(username="siriuskoan")</code> 即可。這樣還沒結束，我們可以繼續加更多 <code>filter_by</code>，就這樣一直連著下去。直到最後，我們要把那些物件抓出來，這時候就可以使用 <code>all()</code> 或是 <code>first()</code>，此處使用者名稱不會重複，所以直接用後者沒有問題。
            </p>
            <p>
                <code>check_password</code> 則是我們之前在寫資料庫的時候就寫好的東西，如果通過的話，就會建立一個剛剛寫好的 <code>User</code> (繼承 <code>UserMixin</code>)，然後設定好 <code>id</code> 並且送回來，等等在寫路徑的時候就會用到他的這個回傳。
            </p>
            <p>
                接下來加入 HTML，一樣直接繼承自 <code>base.html</code>。
            </p>
            <script src="https://gist.github.com/SiriusKoan/d6c4bcd13873f3dcb75e4cc19ddff9cb.js"></script>
            <p>
                它裡面有一個 <code>form</code>，等等我們會用 <code>render_template</code> 傳入，他就是我們的 <code>LoginForm</code>。後面三個很明顯就是我們在 <code>forms.py</code> 寫好的欄位，比較特別的是第一個。在好幾天前說 Flask-WTF 的時候有提到他可以防止 CSRF，就是利用這個 <code>csrf_token</code>，如果沒有他的話，Flask-WTF 會噴錯誤，除非在設定加上 <code>WTF_CSRF_ENABLED = False</code>，像是測試的設定那個樣子。
            </p>
            <p>
                最後就可以進入路徑本身了，我們會用到很多函式，之前提過的 flask 函式就不會再說了，請自行引入。
            </p>
            <script src="https://gist.github.com/SiriusKoan/00b0af008cf603c76d31765b67d964a7.js"></script>
            <p>
                在開始解釋之前，應該會注意到有很多之前沒看過的東西，像是 <code>current_user</code>、<code>login_user</code>，他們都要從 <code>flask_login</code> 引入 (<code>from flask_login import current_user, login_user</code>)。<code>current_user</code> 就是現在的使用者，如果沒登入的話就會是匿名使用者是，他跟 <code>current_app</code> 有點像，就是可以在任意地方抓到現在的東西。而 <code>login_user</code> 就是讓使用者登入用的，等等看到後面會比較清楚。
            </p>
            <p>
                可以看到在路徑的最一開始我們先做的一個判斷，使用了 <code>current_user.is_active</code>，他代表這個使用者是否 active，基本上就是是否有登入。其他還有一些東西也可以判斷，像是 <code>current_user.is_anonymous</code> 就可以看他是不是匿名使用者。有興趣的話可以打開 <code>UserMixin</code> 的原始碼，會看到他有一些 property 可以用，而在他下面會有一個叫作 <code>AnonymousUserMixin</code> 的物件，如果在沒有登入的狀況下看 <code>current_user</code> 就會看到他，他的 <code>is_anonymous</code> 就是 <code>True</code>。如果這個判斷是成立的話，我們就 <code>flash</code> 一個小訊息，然後把它重新導向到 dashboard；如果不成立 (他還沒登入)，那我們會先宣告一個 <code>form</code>，他是 <code>LoginForm</code> 的實體，然後在 <code>request.method == "GET"</code> 的時候把它傳出去，也就是剛剛 HTML 看到的 <code>form</code>。
            </p>
            <p>
                基本上來說 GET 沒什麼好說的，精彩的在 POST。一開始我們先判斷 <code>form.validate_on_submit()</code>，他就是我們之前的一堆驗證，如果不過的話就會有錯誤訊息出來，所以我們先看看沒過的情況，我們要從 <code>form.errors.items()</code> 把錯誤撈出來，他會包含 <code>field</code> 和 <code>errors</code> 兩個部分，前者代表錯誤發生的欄位，後者代表錯誤訊息，而這個錯誤訊息可能很多條，所以他是一個 list，要 for 把他一條一條抓出來然後 <code>flash</code> 出去。
            </p>
            <p>
                接著回到驗證過的情況，我們就從表單裡面取出資料，收進 <code>username</code> 和 <code>password</code> 裡面，接著用剛剛寫好的 <code>login_auth</code> 來看看有沒有通過，如果是正確的帳號密碼，那就會收到他生出來的使用者，接著用 <code>login_user</code> 把它登入，然後再 然後再 <code>flash</code>一些東西，最後重新導向到 dashboard，如果驗證失敗的話，那就會繞回來讓使用者重新驗證。
            </p>
        </div>
        <div class="post_content" id="/logout">
            <h2><a href="#/logout">/logout</a></h2>
            <p>
                剛剛看完複雜的登入頁面，現在來看看簡單的登出頁面。
            </p>
            <script src="https://gist.github.com/SiriusKoan/4e33c9e17acbbe38f03ca6730ff07369.js"></script>
            <p>
                就這樣，非常簡短。其中有個 <code>logout</code> 沒有看過，他也是要從 Flask-Login 引入的函式，功能就是登出使用者。他不需要參數，反正他會把 session 清乾淨，然後我們只需要重新導向到首頁就好。
            </p>
        </div>
        <div class="post_content attachment" id="References">
            <h2><a href="References">References</a></h2>
            <a href="https://flask-login.readthedocs.io/en/latest/#how-it-works">Flask-Login How it Works</a>
            <a href="https://hackmd.io/@shaoeChen/ryvr_ly8f?type=view">Flask實作_ext_11_Flask-Login_登入狀態管理</a>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>
