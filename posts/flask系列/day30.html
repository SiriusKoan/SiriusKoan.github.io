<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 30 最後的收尾</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#admin_required">admin_required</a>
        <a href="#AddUserForm">AddUserForm</a>
        <a href="#結語">結語</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 30 最後的收尾</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                今天是這個系列的最後一篇，我們會把之前沒有做的東西補起來，他們都是蠻麻煩有點 tricky 的東西。
            </p>
        </div>
        <div class="post_content" id="admin_required">
            <h2><a href="#admin_required">admin_required</a></h2>
            <p>
                之前我們說過，在 <code>admin_bp</code> 裡面的路徑沒有辦法用 <code>login_required</code>，因為他只會驗證使用者是否有登入，但不會判斷該使用者是否為管理員。所以我們需要自己寫一個 <code>admin_required</code>。
            </p>
            <p>
                我們要回到 <code>app/user_helper.py</code>，然後對 <code>login_manager</code> 做一點點的修改。
            </p>
            <script src="https://gist.github.com/SiriusKoan/1d45872efee42fb813e611319ca5f985.js"></script>
            <p>
                我們重新定義了一個 <code>LoginManager_</code>，並在裡面新增了 <code>forbidden</code> 這個函式，他是 <code>unauthorized</code> 的變形，基本上都是直接超過來的，我們只把裡面的 <code>abort</code> 的 status code 改成 403 而已。這個 <code>unauthorized</code> 會在 <code>login_required</code> 裡面用到，所以我們在這邊加入一個 <code>forbidden</code> 之後，就可以在 <code>admin_required</code> 裡面使用了，所以我們馬上就來寫他。
            </p>
            <script src="https://gist.github.com/SiriusKoan/e4caf59d11840e0763c3f06c92097cc1.js"></script>
            <p>
                基本上它的結構也跟 <code>login_required</code> 很像，但我們有修改裡面的邏輯判斷，讓他可以確定他有沒有登入和是否為管理員。最後我們再把這個裝飾器加到每個 <code>admin_bp</code> 裡面，就可以做出 <code>admin_required</code> 的效果了。
            </p>
            <p>
                這邊我們沒有多做解釋，如果有興趣的話可以去看 Flask-Login 的原始碼。
            </p>
        </div>
        <div class="post_content" id="AddUserForm">
            <h2><a href="#AddUserForm">AddUserForm</a></h2>
            <p>
                加入一個表單並不是一件很難的事，在之前我們都做過了好多次，但這次情況有點不太一樣，因為我們要在同一個頁面 (管理使用者的頁面) 放兩個表單，這會讓 <code>form.validate_on_submit</code> 變得有點奇怪。
            </p>
            <p>
                我們要先稍微修改一下 <code>AddUserForm</code> 和 <code>UserFilterForm</code> 的欄位，他們要各多加一個小欄位。
            </p>
            <script src="https://gist.github.com/SiriusKoan/813e007f79e514503e2eb9d91d903385.js"></script>
            <p>
                我們各加了一個 <code>HiddenField</code>，我們等等會用這個欄位來判斷現在使用的是哪一個表單。以下的程式碼只有在 POST 底下的部分，<code>form</code> 還是原來在用的 <code>UserFilterForm</code>，而 <code>form_add_user</code> 則是 <code>AddUserForm</code>。接下來我們抓 <code>request.form["form_name"]</code> 也就是剛剛我們放進去的 <code>HiddenField</code>，然後在下面判斷要用哪一個表單。
            </p>
        </div>
        <div class="post_content" id="結語">
            <h2><a href="#結語">結語</a></h2>
            <p>
                這系列的文章就到這邊告一段落，希望不管是跟著鐵人賽期間一篇一篇看的人，或是在查資料偶然翻到這個系列的人都可以有一些收穫，也謝謝你們願意閱讀這篇文章。
            </p>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>
