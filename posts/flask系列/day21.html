<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 21 實作路徑結構</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#main_bp">main_bp</a>
        <a href="#user_bp">user_bp</a>
        <a href="#admin_bp">admin_bp</a>
        <a href="#後記">後記</a>
        <a href="#References">References</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 21 實作路徑結構</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                今天我們要來開始寫路徑，也就是說在今天寫完之後我們就可以把之前藍圖的註解取消了。
            </p>
        </div>
        <div class="post_content" id="main_bp">
            <h2><a href="#main_bp">main_bp</a></h2>
            <p>
                首先，我們來看看最簡單的 <code>main_bp</code>，裡面基本上只有一個路徑，就是首頁。
            </p>
            <p>
                在開始之前，我們要先在 <code>app/main/</code> 裡面加一個 <code>views.py</code>，等等路徑會寫在這裡面。
            </p>
            <script src="https://gist.github.com/SiriusKoan/7d19a9504335b8db10bf3b1b75b58d77.js"></script>
            <p>
                這邊的 <code>__init__.py</code> 跟很久以前寫的有一點點不太一樣，多加了一行 <code>from . import views</code>，這樣他才會被好好 register 進 <code>app</code>。
            </p>
            <p>
                接下來看到 <code>views.py</code>，要特別注意，我們是用 <code>main_bp</code> 來註冊路徑，而不是 <code>app</code>，所以我們也需要從剛剛的  <code>__init__.py</code> 裡面引入 <code>main_bp</code>。裡面有一個 <code>index_page</code>，我們不會拿它來幹嘛，就是一個放好看的頁面而已，也不會有甚麼表單，所以 <code>methods</code> 就只有最簡單的 GET。
            </p>
            <p>
                再來是兩個 <code>app_error_handler</code>，他們就是用來處理錯誤的。第一個是處理 401 錯誤，也就是未驗證，之前在寫測試的時候有說過我們要讓他直接重新導向至登入頁面。剩下的錯誤就交給第二個，我們用 <code>HTTPException</code> 來接收，我們之後會寫一個模板給他，讓不管什麼錯誤都可以回傳模板。他們兩個都有一個 <code>e</code> 作為參數，他就是那個錯誤本身，我們之後會在第二個 handler 用到他。
            </p>
        </div>
        <div class="post_content" id="user_bp">
            <h2><a href="#user_bp">user_bp</a></h2>
            <p>
                接著要看到 <code>user_bp</code>，這裡會有一堆跟使用者有關的路徑，像是登入登出、貼文、使用者設定等等。跟剛剛一樣，我們也需要一個 <code>views.py</code>，而這次路徑比較多，所以也可以把他拆開來，但要記得，在 <code>__init__.py</code> 要把每一個路徑檔案都引入。
            </p>
            <script src="https://gist.github.com/SiriusKoan/86a3e2227e6b8ebd5009f87247cee047.js"></script>
            <p>
                這邊路徑很多，我們一個一個來解釋。但開始講路徑之前，我們先來看看最前面的 <code>login_required</code>。顧名思義，他就是要求使用者要先登入才能進入這個網頁，如果沒登入的話就會丟出 401，那根據剛剛 <code>main_bp</code> 的 <code>app_error_handler</code>，他會重新導向到登入頁面。但現在他還不能使用，因為我們還沒有完成 FLask-Login 的一些要求，所以現在他會噴錯誤。
            </p>
            <p>
                接下來就來看看各個路徑要幹嘛吧，我們會用路徑來表示。
            </p>
            <ul>
                <li>
                    <code>/login</code> 當然就是登入頁面，我們需要有 GET 和 POST，這樣才能送表單出去。
                </li>
                <li>
                    <code>/logout</code> 是登出頁面，戳一下系統就會把使用者登出。
                </li>
                <li>
                    <code>/register</code> 是註冊頁面，跟登入頁面同理，也需要 GET 和 POST。
                </li>
                <li>
                    <code>/setting</code> 是使用者設定頁面，一樣需要提交表單，所以 GET 和 POST 都要。
                </li>
                <li>
                    來到了貼文的部分，<code>/post/add</code> 是新增貼文的頁面，也就是之前說要放 pagedown 表單的地方。這邊當然需要做 <code>login_required</code>，除非要允許匿名發文。
                </li>
                <li>
                    <code>/post/edit/&lt;int:post_id&gt;</code> 是編輯貼文的地方，我們會跟新增貼文用一樣的表單。但這邊需要 <code>post_id</code>，這樣才知道現在在修改哪一篇文章。
                </li>
                <li>
                    <code>post/delete/&lt;int:post_id&gt;</code> 會用來刪除貼文，就像登出一樣，戳一下文章就被刪掉了。
                </li>
                <li>
                    <code>/dashboard</code> 是使用者看自己全部貼文的地方，因為有篩選器的表單，所以這裡也需要 POST。
                </li>
                <li>
                    <code>/comments</code> 是使用者看自己全部留言的地方，但我們在這裡沒有做篩選器，所以就不需要 POST 了，
                </li>
                <li>
                    <code>/posts</code> 是看整個系統全部人文章的地方，也可以不要 <code>login_required</code>，這樣匿名使用者也可以看到文章。
                </li>
                <li>
                    <code>/post/&lt;int:post_id&gt;</code> 則是看某一篇文章，後面的 <code>post_id</code> 會告訴系統要抓哪一篇文章出來。他也需要 POST，因為留言的表單會放在這裡。
                </li>
                <li>
                    <code>/@&lt;username&gt;/posts</code> 是一個額外的東西，可以把該使用者的貼文全部抓出來。
                </li>
            </ul>
        </div>
        <div class="post_content" id="admin_bp">
            <h2><a href="#admin_bp">admin_bp</a></h2>
            <p>
                最後我們來到了 <code>admin_bp</code>，比起剛剛，這裡的路徑就少了不少。這邊有一些不太一樣的路徑，它們是只接收 POST、DELETE 等等 method，所以使用者不會直接去戳到他，而是要靠 JS 之類的東西來戳。
            </p>
            <script src="https://gist.github.com/SiriusKoan/a1e2c4f2a4fe8c3a60a9dab2a9d45dab.js"></script>
            <p>
                這裡分成前面三個和後面三個，分別是給使用者用的和給 JS 戳的，所以後者我會等到真的在寫的時候再詳細講，然後他們也是一一對應的。接下來就一個一個看看他們。
            </p>
            <ul>
                <li>
                    <code>/admin_dashboard/posts</code> 是給管理員看全部貼文的地方，同時也會允許管理員直接刪除貼文，請求會由 JS 送到 <code>admin_dashboard_posts_backend</code>。他需要有 POST，因為有篩選器要用。
                </li>
                <li>
                    <code>/admin_dashboard/comments</code> 跟剛剛接近，只是是看留言的地方。也需要 POST，因為有篩選器。
                </li>
                <li>
                    <code>/manage_user</code> 是管理使用者的頁面，可以看到所有使用者，然後也可以刪除、更新 (<code>manage_user_backend</code>) 及新增 (表單)。
                </li>
            </ul>
        </div>
        <div class="post_content" id="後記">
            <h2><a href="#後記">後記</a></h2>
            <p>
                在這邊全部結束之後，我們就可以把之前 <code>app/__init__.py</code> 那些對於藍圖的註解移除，然後使用 <code>flask shell</code> 來看看 <code>app.url_map</code> 有沒有一大堆東西，如果有那基本上就是成功了。
            </p>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>
