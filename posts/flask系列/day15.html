<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 15 實作測試 (1)</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#前置作業">前置作業</a>
        <a href="#basic_test">basic_test</a>
        <a href="#helper">helper</a>
        <a href="#References">References</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 15 實作測試 (1)</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                今天要開始寫測試，這個部份我們不會特別認真寫，重點是要把比較常用的函式秀出來。我們會用最原始的 unittest 套件來寫，當然也可以自己改成 pytest
                等等其他測試框架。
            </p>
        </div>
        <div class="post_content" id="前置作業">
            <h2><a href="#前置作業">前置作業</a></h2>
            <p>
                雖然說是前置作業，但這個步驟放到最後也沒有關係。我們要來在 <code>manage.py</code> 再加入一個新指令。當然要記得 <code>import unittest</code>
            </p>
            <script src="https://gist.github.com/SiriusKoan/430cbf2c2f7e014c3d8fe8f2dca2ec2b.js"></script>
            <p>
                這是一段 unittest 很常見的程式碼，基本上他會找到之前已經建好的 <code>tests/</code> 然後跑裡面全部的測試。
            </p>
            <p>
                這樣一來，等等測試寫完之後就可以使用 <code>flask test</code> 來跑測試了。
            </p>
        </div>
        <div class="post_content" id="basic_test">
            <h2><a href="#basic_test">basic_test</a></h2>
            <p>
                我們今天會寫出 basic test 跟藍圖 <code>main_bp</code> 的測試，先從前者開始。以下程式碼要放在 <code>tests/test_basic.py</code> 裡面。
            </p>
            <script src="https://gist.github.com/SiriusKoan/a67643e2a6bc37f2083b47e6b824ee77.js"></script>
            <p>
                我們在 <code>setUp</code> 裡面先用 <code>create_app</code> 建好一個 <code>app</code>，接著使用了
                <code>test_client</code>，他是一個讓我們可以模擬客戶端的工具，可以使用他來對 <code>app</code> 發 request。接下來的兩行跟
                <code>app_context</code> 有關，基本上它就是把一個環境套用到裡面，這樣之後的程式碼都會在這個環境之下。然後因為在 <code>setUp</code> 我們套用了
                <code>app_context</code>，那在結束 <code>tearDown</code> 的時候就要把他 <code>pop</code> 掉，這樣才不會影響之後的測試。
            </p>
            <p>
                如果覺得有點難懂的話，可以打開 python，然後直接呼叫
                <code>current_app.config</code>，他會告訴你 <code>Working outside of application context.</code>，這時候如果你給他一個
                <code>app.app_context().push()</code> (當然 <code>app</code> 要自己宣告)
                再呼叫一次，就可以看到他沒有錯誤然後給你一個好好的設定檔，就像我們之前看到的那樣，而 <code>pop</code> 掉之後他又會變成跑出錯誤。在這裡做的事就接近上述的行為，只是把在同一個 python
                interpreter 的環境變成在同一次測試的環境。
            </p>
            <p>
                接下來我們繼續看到後面，這裡有兩個測試，第一個是透過抓首頁來確定 <code>app</code> 有沒有好好活著；第二個是確定藍圖有沒有被好好的載入。我們分開來說明。
            </p>
            <ul>
                <li>
                    在 <code>test_app_is_alive</code> 中，我們使用了剛剛宣告的 <code>self.client</code>，並使用了他的 <code>get</code>
                    函式，這個跟 HTTP method 的那個 <code>get</code> 是同一個，所以可想而知，後面一定會有 <code>post</code>、<code>put</code>
                    等等類似的函式。而他會回傳一個 response，我們可以來檢查他的回應有沒有符合預期。此處我們去看他的 <code>status_code</code> 是不是 200。
                </li>
                <li>
                    在 <code>test_blueprint</code> 裡面，我們去檢查 <code>self.app.blueprints</code> 裡面有沒有該有的藍圖，他是 dict
                    型別，所以可以這樣去確認。
                </li>
            </ul>
        </div>
        <div class="post_content" id="helper">
            <h2><a href="#helper">helper</a></h2>
            <p>
                因為測試很多函式的重複性很高，所以在開始寫 <code>main_bp</code> 的測試前，我們先來寫一下 <code>helper.py</code>，一樣要放在 <code>tests/</code>
                裡面。
            </p>
            <script src="https://gist.github.com/SiriusKoan/8fca804353f8cfcb0b6ed4c5ac40275d.js"></script>
            <p>
                在這裡面我們定義了一個 <code>TestModel</code>，我們之後的測試都會換成繼承他，而非剛剛的
                <code>unittest.TestCase</code>，也因為如此，接下來定義的函式都不是測試，而是給測試用的工具。在
                <code>setUp</code> 還有 <code>tearDown</code> 跟剛剛做的事差不多，有差別的部份是我們新增了 <code>user_data</code> 和
                <code>admin_data</code>，這在之後登入會用到。同時我們也用之前寫好的 <code>add_user</code> 來加入兩個測試用的使用者。還有我們也在
                <code>tearDown</code> 加入了清除資料庫的動作。
            </p>
            <p>
                接著我們定義了 <code>user_login</code> 和 <code>admin_login</code>，這邊就用到剛剛提到的 <code>post</code> 這個函式，然後他使用
                <code>data</code> 參數把登入資料丟進去。再用 <code>login</code> 把上述兩者包裝起來給之後的函式用。
            </p>
            <p>
                接下來我們自己定義了 <code>get</code> 和 <code>post</code>
                兩個函式，讓它包含登入的功能，登入有很多種寫法，但有時候並沒有那麼直觀，可能會遇到明明登入了但後面發請求的時候又變成沒登入，這常常都是因為 context 不對。<code>post</code>
                的部分跟剛剛一樣都使用 <code>data</code> 參數來把資料傳送給後端。我們還用到了一個叫做 <code>follow_redirects</code> 的參數，如果不讓他 follow 的話，那
                <code>status_code</code> 就會變成 302，然後我們看到的資料也都是重新導向頁面的資料，而這通常不是我們樂見的 (除非我們只想確定他有重新導向)，因此在此處我們加上這個參數。
            </p>
        </div>
        <div class="post_content attachment" id="References">
            <h2><a href="#References">References</a></h2>
            <a href="https://www.maxlist.xyz/2020/08/17/flask-unittest/">【Flask 教學】實作 Flask 單元測試 Unit Test</a>
            <a href="https://flask.palletsprojects.com/en/2.0.x/testing/">Testing Flask Applications</a>
            <a
                href="https://stackoverflow.com/questions/17375340/testing-code-that-requires-a-flask-app-or-request-context">Testing
                code that requires a Flask app or request context</a>
            <a href="https://testdriven.io/blog/flask-contexts/">Understanding the Application and Request Contexts in
                Flask</a>
            <a href="https://stackoverflow.com/questions/21506326/testing-flask-login-and-authentication">Testing Flask
                login and authentication?</a>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>