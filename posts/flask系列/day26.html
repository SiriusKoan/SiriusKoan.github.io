<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 26 實作 user_bp (4)</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#/dashboard">/dashboard</a>
        <a href="#/post/delete">/post/delete</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 26 實作 user_bp (4)</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                今天我們要來處理 dashboard 的部分，但僅限於貼文的，留言的要留到明天。
            </p>
        </div>
        <div class="post_content" id="/dashboard">
            <h2><a href="#/dashboard">/dashboard</a></h2>
            <p>
                第一個要來看的是 dashboard，有些東西還沒有寫好 (像是刪除之類的)，會等寫完這邊再回去看。
            </p>
            <p>
                一樣，先來看看資料庫方面的程式碼。
            </p>
            <script src="https://gist.github.com/SiriusKoan/9ad4e8b13b3416e59d0b0579018d1795.js"></script>
            <p>
                這邊我們讓他接收一些過濾器去做篩選，然後把過濾過的貼文都抓出來，再丟進昨天寫的 <code>render_post</code> 讓他轉成 dict。這邊值得注意一下的是我們有 <code>filter</code> 也有 <code>filter_by</code>，後者是我們熟悉的，而前者也一樣是篩選器，只是它裡面放的是判斷式，所以如果之前的 <code>filter_by</code> 想要改成 <code>filter</code>，那就要把 <code>=</code> 改成 <code>==</code>。
            </p>
            <p>
                接下來進入 HTML，這次會比前面複雜一些，因為要加上顯示貼文。
            </p>
            <script src="https://gist.github.com/SiriusKoan/a1d95763db9924da71d9fd3406f5015b.js"></script>
            <p>
                最上面我們一樣放了表單，是 filter 那個。然後在下面我們用到了 <code>posts</code>，這是剛剛 <code>get_posts</code> 弄出來的，所以會是一個有很多貼文 dict 的 list，我們就一個一個抓出來，然後把它的資訊呈現出來。我們放了很多連結，現在只有編輯的部分昨天實作了，剩下的我們會等等完成。
            </p>
            <p>
                最後來到路徑本身，他也相對複雜。
            </p>
            <script src="https://gist.github.com/SiriusKoan/c04c74e88929c890ab944f463c2a281a.js"></script>
            <p>
                在判斷 <code>request.method</code> 前，我們有一小串跟其他路徑不一樣的程式碼，它是用來取出 cookie 的，因為我們會把使用者指定的 filter 存在 cookie 裡面。以現在的狀況來看這基本上是多餘的，直接把過濾過的貼文送出去就好，但如果未來我們加入分頁的功能，那就沒有這麼好處理了，所以我們在這邊選擇用 cookie。這個從 cookie 抓出來的 dict 除了要給 <code>get_posts</code> 用之外，也要給 <code>DashboardFilterForm</code> 當作預設值，這樣使用者就可以看到他設定的過濾器是什麼。後面的部分基本上就是處理 cookie，要把表單送過來的東西都轉成 cookie。
            </p>
            <p>
                這裡會有一個小問題發生在處理日期結束的地方，假設我們說結束時間是 <code>2021-01-02</code>，但事實上在資料庫時間比大小的時候 <code>2021-01-02</code> 的資料不會跑出來，因為我們說的結束時間會被當成 <code>2021-01-02 00:00:00</code>，這樣就會讓那些 <code>2021-01-02</code> 的資料被過濾掉，平常我自己會直接手動加一天，不過為了簡潔一點，我這邊就跳過這個部分。
            </p>
        </div>
        <div class="post_content" id="/post/delete">
            <h2><a href="#/post/delete">/post/delete</a></h2>
            <p>
                接著我們來看看刪除文章爺樣從資料庫的部分看起。
            </p>
            <script src="https://gist.github.com/SiriusKoan/b9d226b9c77446202475e363671c0302.js"></script>
            <p>
                他有 <code>user_id</code>、<code>post_id</code> 兩個參數，會需要前者是因為我們不能讓莫名其妙的人亂刪別人的文章，所以必須確定要刪除這篇文章的人的確是其所有者。我們刪除的方法是用 <code>db.session.delete()</code>，裡面的參數是物件，而不是 query，所以要記得 <code>.first()</code>。
            </p>
            <p>
                而他不會有 HTML，來看路徑就知道為什麼了。
            </p>
            <script src="https://gist.github.com/SiriusKoan/8c41b1796e6bac005bb202a716b04def.js"></script>
            <p>
                他的路徑非常簡單，基本上就是把 <code>post_id</code> 轉送給剛剛的 <code>delete_post</code>，最後再重新導向到 dashboard。
            </p>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>
