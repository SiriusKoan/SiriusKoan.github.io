<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 14 實作 database migration</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前言">前言</a>
        <a href="#初始化">初始化</a>
        <a href="#flask_db">flask db</a>
        <a href="#References">References</a>
    </div>
    <main>
        <h1 id="title"><a href="#">Day 14 實作 database migration</a></h1>
        <div class="post_content" id="前言">
            <h2><a href="#前言">前言</a></h2>
            <p>
                昨天講完了 <code>manage.py</code> 跟我們新加入的幾個自訂指令，今天我們還是離不開 <code>manage.py</code>，而且昨天引入但是沒有用到的
                <code>db</code> 也要登場了。
            </p>
            <p>
                今天要登場的是 database migration，它是用來更新資料庫結構的，可以想成資料庫的版本控制。
            </p>
        </div>
        <div class="post_content" id="初始化">
            <h2><a href="#初始化">初始化</a></h2>
            <p>
                我們要先在 <code>manage.py</code> 裡面加入以下幾行。
            </p>
            <script src="https://gist.github.com/SiriusKoan/66cf928f55f748f519199a2cef89cc04.js"></script>
            <p>
                這樣就完成了，現在我們可以使用 <code>flask</code> 指令來處理資料庫的變化了。
            </p>
        </div>
        <div class="post_content" id="flask_db">
            <h2><a href="#flask_db">flask db</a></h2>
            <p>
                在開始之前，我們要先把 <code>data.db</code> (之前生出來的資料庫檔案) 刪掉，然後重新開始。
            </p>
            <p>
                最一開始，我們需要先初始化，要使用 <code>flask db init</code>，他應該會跑一下下，然後生出一個叫做 <code>migration/</code> 的目錄，但現在裡面還沒甚麼內容。
            </p>
            <p>
                接著我們要使用 <code>flask db migrate -m "description"</code> 來建立一個版本，<code>-m</code> 後面要加上這個版本的說明之類的，有點像 git
                的感覺。而這個版本的來源是我們的 <code>models.py</code>，而不是現在資料庫的樣子。這樣一來，他就會生出一個新的版本，放在 <code>migration/versions/</code>
                裡面，他會有一個獨特的編號，像 git 每一個 commit 都有編號一樣。
            </p>
            <p>
                但建好這個版本之後，我們資料庫還沒有跟上，必須要使用 <code>flask db upgrade</code> 來把它升級到新版本，理論上第一個版本應該是建立好三個
                table。這時候打開資料庫，應該會看到裡面已經有建好的 table，然後還有外加一個 Flask-Migrate 在用的 table。
            </p>
            <p>
                我們現在可以嘗試在這個資料庫裡面加入一些資料，加入文章跟留言會被昨天提到的外鍵卡到，所以我們加入一個新的使用者來當作範例，看等等建立新版並且升級之後這筆資料會發生甚麼事。
            </p>
            <p>
                接著我們到 <code>models.py</code> 稍微調整一下資料庫結構，我們嘗試加入一個 <code>test = db.Column(db.String)</code> 在
                <code>Users</code> 裡面。現在我們的 <code>models.py</code> 已經更動了，所以我們可以建立新的版本，再次使用
                <code>flask db migrate</code>，這時候應該可以看到他會說偵測到有加入的
                column，然後一個新版本就建好了。在升級之前我們可以看看一些小東西。<code>flask db current</code> 會讓你知道你現在在哪個版本，而
                <code>flask db heads</code> 則會讓你知道現在的最新版本。
            </p>
            <p>
                看完之後應該就可以看到 <code>current</code> 跟 <code>heads</code>
                是不一樣的，所以這時候就可以再來 <code>flask db upgrade</code>，讓他升級上去。最後我們打開資料庫，應該會看到 <code>users</code> 這個 table
                已經更新了，加入了一個新的欄位，但同時舊的資料也沒有被刪除。
            </p>
            <p>
                當然，這是一個測試用的版本，我們不會留在這個版本做事，所以我們要用 <code>flask db downgrade</code> 來退回前一個版本。在最一開始的初始化中，我們加入了一個
                <code>render_as_batch</code> 的參數，會加入他是因為我們開發中先使用
                sqlite，但他遇到刪除欄位的時候會爆炸，加上這個參數之後他就會換個方式，會變成把本來的資料庫砍掉然後重建，再把舊的資料複製過去新的，所以就可以避免掉 sqlite 不讓我們刪除的問題。
            </p>
        </div>
        <div class="post_content attachment" id="References">
            <h2><a href="#References">References</a></h2>
            <a
                href="https://medium.com/seaniap/python-web-flask-%E5%AF%A6%E4%BD%9C-flask-migrate%E6%9B%B4%E6%96%B0%E8%B3%87%E6%96%99%E5%BA%AB-a5ebc930422a">實作
                Flask-Migrate更新資料庫</a>
            <a href="https://ithelp.ithome.com.tw/articles/10205751">DAY26-搞懂Flask-Migrate</a>
            <a
                href="https://hackmd.io/@shaoeChen/HJiZtEngG/https%3A%2F%2Fhackmd.io%2Fs%2Fr1luGOkVf">Flask實作_ext_06_Flask-Migrate</a>
            <a href="https://stackoverflow.com/questions/30394222/why-flask-migrate-cannot-upgrade-when-drop-column">Why
                Flask-migrate cannot upgrade when drop column</a>
            <a
                href="https://stackoverflow.com/questions/30378233/sqlite-lack-of-alter-support-alembic-migration-failing-because-of-this-solutio">Sqlite
                lack of ALTER support, Alembic migration failing because of this. Solutions?</a>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2021 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>