<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>From Docker to K8s With Koel</title>
    <link rel="icon" href="/img/me.jpg">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/gist.css">
</head>

<body>
    <header>
        <nav>
            <a href="/" class="header-content">SiriusKoan</a>
            <a href="/posts" class="header-content">Posts</a>
            <a href="/about.html" class="header-content">About Me</a>
        </nav>
    </header>
    <a id="top-button" href="#"><span>TOP</span></a>
    <div id="toc">
        <a href="#前情提要">前情提要</a>
        <a href="#Environment">Environment</a>
        <a href="#從 Docker 開始">從 Docker 開始</a>
        <a href="#開始搬上 K8s">開始搬上 K8s</a>
        <a href="#把 koel 打出去">把 koel 打出去</a>
        <a href="#References">References</a>
    </div>
    <main>
        <h1 id="title"><a href="#"></a>From Docker to K8s With Koel</h1>
        <div class="post_content" id="前情提要">
            <h2><a href="#前情提要">前情提要</a></h2>
            <p>
                前陣子心血來潮，想說來自架一下 spotify alternative，翻了一下文章之後選擇試試 <a href="https://koel.dev/">Koel</a>。
            </p>
            <p>
                整體 UI 算是好看，但功能上一直有些問題，像是上傳有奇怪的限制，所以後來雖然架成功，但幾經思量後還是把他砍掉換成了
                <a href="https://jellyfin.org/">jellyfin</a>。不過雖然被我換掉，整體的架設過程還是值得紀錄一下。
            </p>
        </div>
        <div class="post_content" id="Environment">
            <h2><a href="#Environment">Environment</a></h2>
            <p>Koel 需要 database 和存放音樂檔案的空間，這個部份我選擇用另外的 VM 解決，這樣自己在管理上和更新資料（上傳音樂）會比較方便</p>
            <p>
                我開了兩台 VM，一台用來放檔案，hostname 是 <code>nfs</code>，以及另一台當資料庫，這次選擇採用 Postgresql，hostname 是 <code>db</code>。
            </p>
        </div>
        <div class="post_content" id="從 Docker 開始">
            <h2><a href="#從 Docker 開始">從 Docker 開始</a></h2>
            <p>
                要用這類開源專案，我第一步都是先去 github 看看，但<a href="https://github.com/koel/koel">主要的 github</a>
                沒有 docker 相關的文件，最後翻了一下，發現他放在<a href="https://github.com/koel/docker">另一個 repo</a> 裡面。
            </p>
            <p>
                在 repo 裡面發現有一份用 Postgresql 的 <code><a href="https://github.com/koel/docker/blob/master/docker-compose.postgres.yml">docker-compose.yaml</a></code>，所以就先把他抓下來研究。
            </p>
            <p>我在這邊主要看三個部分。</p>
            <ul>
                <li><code>service</code>，像這邊就是 koel 本身和 database。</li>
                <li><code>volumes</code>，這關乎 K8s 裡面的 PV 和 PVC 要開甚麼。不過這邊我們會用 NFS 處理掉，所以他影響的是在 NFS 上要管理那些目錄。</li>
                <li><code>environment</code>，這到時候要直接拉進 K8s 的部署 YAML。</li>
                <li><code>ports</code>，這是 deployment 要打出去的 port</li>
            </ul>
            <p>其他部分（像是 <code>image</code> 之類的）當然也要搬遷，基本上就是搬過去，相對簡單，所以這邊就不特別討論。</p>
        </div>
        <div class="post_content" id="開始搬上 K8s">
            <h2><a href="#開始搬上 K8s">開始搬上 K8s</a></h2>
            <p>
                確定完這些內容後，我們就可以開始搬遷。但最一開始我們要先把和 K8s 無關的部分解決掉，以我的狀況來說，就是資料庫以及 NFS 的問題，所以要先去開好。
            </p>
            <p>接著就可以把 <code>docker-compose.yaml</code> 的內容搬過來了。</p>
            <p>
                在搬的過程中，我們也可以把 <code>DB_USERNAME</code> 和 <code>DB_PASSWORD</code> 這種較為敏感的資訊另外存一份 configmap。
            </p>
            <p>最後的結果是：</p>
            <script src="https://gist.github.com/SiriusKoan/c7418fde476e48186030972d2a902440.js"></script>
            <p>
                這裡面有一個剛剛沒有提到的 <code>lifecycle</code>，這個指令是在
                <a href="https://github.com/koel/docker#first-run">官方文件</a>
                中提到要在第一次跑的時候執行的指令。如果有遇到 <code>.env</code> 沒有設定好之類的問題，八成就是因為沒跑這個。
            <p>
                在這邊我們用在 <code>postStart</code> 的時候來執行，根據
                <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-state-running">K8s lifecycle 的文件</a>
                ，他會在進入 running status 之前先跑完，這符合我們想要的「在第一次執行前先跑」。
            </p>
            <p>至此，我們就可以 apply 這兩個 resource，然後讓 koel 跑起來。</p>
        </div>
        <div class="post_content" id="把 koel 打出去">
            <h2><a href="#把 koel 打出去">把 koel 打出去</a></h2>
            <p>當 koel deployment 跑起來之後，我們還必須要把他打出去。我們會使用 service (cluster-IP) 和 ingress 做搭配。</p>
            <p>這個部分就相對簡單，把 service 接上 koel 的 deployment，然後 ingress 再接上 service，這樣就可以出去了。</p>
            <script src="https://gist.github.com/SiriusKoan/f477a286d22941ecfeb9043362e7d6ea.js"></script>
            <p>
                要注意的是，我們畢竟不是用 deployment 裡面的 web server，上傳檔案時會經過 ingress，所以必須要把
                <code>nginx.ingress.kubernetes.io/proxy-body-size: 1g</code>，不然會在 ingress 的時候就被擋掉。
            </p>
            <p>
                另外，我想要開兩個 domain 都接到這個服務，但同樣的 http rule 打兩次很難看，所以我使用了
                <a href="https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/">YAML anchors</a> 來簡化。
            </p>
        </div>
        <div class="post_content attachment" id="References">
            <h2><a href="#References">References</a></h2>
            <a href="https://github.com/koel/docker">Koel docker - GitHub</a>
            <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">Pod Lifecycle - Kubernetes</a>
            <a href="https://stackoverflow.com/questions/44140593/how-to-run-command-after-initialization">How to run command after initialization</a>
        </div>
    </main>
    <footer>
        <p id="copyright">© 2022 <a href="https://github.com/SiriusKoan" target="_blank">SiriusKoan</a></p>
    </footer>
</body>

</html>
